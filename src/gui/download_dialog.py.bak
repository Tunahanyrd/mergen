# -*- coding: utf-8 -*-
import os
import subprocess
import time

from PySide6.QtCore import Qt, QThread, QTime, QUrl, Signal
from PySide6.QtGui import QColor, QDesktopServices
from PySide6.QtWidgets import (
    QApplication,
    QDialog,
    QFrame,
    QGraphicsDropShadowEffect,
    QGridLayout,
    QHBoxLayout,
    QLabel,
    QStyle,
    QVBoxLayout,
)

from src.core.config import ConfigManager
from src.core.downloader import Downloader
from src.core.i18n import I18n
from src.gui.widgets.custom_widgets import HeatmapBar, InfoCard, MiniGraph, ModernButton


class MainInfoCard(InfoCard):
    def __init__(self, title, initial_value, parent=None, with_graph=False):
        super().__init__(title, initial_value, parent)
        if with_graph:
            self.graph = MiniGraph(parent=self)
            self.layout().addWidget(self.graph)

    def update_graph(self, value):
        if hasattr(self, "graph"):
            self.graph.add_value(value)


class CompleteDialog(QDialog):
    def __init__(self, filename, parent=None):
        super().__init__(parent)
        self.setWindowTitle(I18n.get("finished"))
        self.resize(500, 300)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setWindowFlags(self.windowFlags() | Qt.FramelessWindowHint)
        self.filename = filename

        self.setup_ui()

    def setup_ui(self):
        container = QFrame(self)
        container.setStyleSheet(
            """
            QFrame {
                background-color: #1e1e2e;
                border: 2px solid #00f2ff;
                border-radius: 20px;
            }
            QLabel { color: #cdd6f4; border: none; }
        """
        )

        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(30)
        shadow.setColor(QColor(0, 242, 255, 60))  # Cyan glow
        shadow.setOffset(0, 0)
        container.setGraphicsEffect(shadow)

        layout = QVBoxLayout(self)
        layout.addWidget(container)

        cl = QVBoxLayout(container)
        cl.setContentsMargins(30, 30, 30, 30)
        cl.setSpacing(20)

        # Icon
        icon_lbl = QLabel()
        icon = QApplication.style().standardIcon(QStyle.SP_DialogApplyButton)
        icon_lbl.setPixmap(icon.pixmap(64, 64))
        icon_lbl.setAlignment(Qt.AlignCenter)
        cl.addWidget(icon_lbl)

        # Title
        title = QLabel(I18n.get("complete") + "!")
        title.setAlignment(Qt.AlignCenter)
        title.setStyleSheet("font-size: 24px; font-weight: bold; color: #00f2ff;")
        cl.addWidget(title)

        # Filename
        fname = os.path.basename(self.filename)
        flbl = QLabel(fname)
        flbl.setAlignment(Qt.AlignCenter)
        flbl.setWordWrap(True)
        flbl.setStyleSheet("font-size: 14px; color: #a6adc8;")
        cl.addWidget(flbl)

        cl.addStretch()

        # Buttons
        btns = QHBoxLayout()

        btn_open = ModernButton(I18n.get("open"), primary=True)
        btn_open.clicked.connect(self.open_file)

        btn_folder = ModernButton(I18n.get("show_in_folder"))
        btn_folder.clicked.connect(self.open_folder)

        btn_close = ModernButton(I18n.get("close"))
        btn_close.clicked.connect(self.accept)

        btns.addWidget(btn_open)
        btns.addWidget(btn_folder)
        btns.addWidget(btn_close)

        cl.addLayout(btns)

    def open_file(self):
        if os.path.exists(self.filename):
            try:
                subprocess.Popen(["kopenwith", self.filename])
            except Exception:
                QDesktopServices.openUrl(QUrl.fromLocalFile(self.filename))
        self.accept()

    def open_folder(self):
        path = os.path.dirname(self.filename)
        if os.path.exists(path):
            try:
                subprocess.Popen(["xdg-open", path])
            except Exception:
                QDesktopServices.openUrl(QUrl.fromLocalFile(path))
        self.accept()

    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton:
            self._drag_pos = event.globalPos() - self.frameGeometry().topLeft()
            event.accept()

    def mouseMoveEvent(self, event):
        if event.buttons() == Qt.LeftButton:
            self.move(event.globalPos() - self._drag_pos)
            event.accept()


class DownloadWorker(QThread):
    progress_signal = Signal(object, object, float, object)
    status_signal = Signal(str)
    finished_signal = Signal(bool, str)

    def __init__(self, url, save_dir=None, proxy_config=None, worker_count=4, format_info=None):
        super().__init__()
        self.url = url
        self.save_dir = save_dir
        self.proxy_config = proxy_config
        self.downloader = None
        self.is_running = True
        self.last_time = time.time()
        self.last_bytes = 0
        self.worker_count = worker_count
        self.format_info = format_info

    def run(self):
        self.downloader = Downloader(
            self.url,
            save_dir=self.save_dir,
            progress_callback=self.emit_progress,
            status_callback=self.emit_status,
            completion_callback=self.emit_finished,
            proxy_config=self.proxy_config,
            worker_count=self.worker_count,
        )

        # Apply format info if provided (v0.9.0)
        if self.format_info:
            self.downloader.format_info = self.format_info

        self.downloader.start()

    def emit_progress(self, downloaded, total, speed=0):
        # Throttle logic integrated
        if self.is_running:
            now = time.time()
            if now - self.last_time < 0.1 and downloaded < total:
                return

            # Use provided speed if available, otherwise calculate
            if speed == 0:
                elapsed = now - self.last_time
                if elapsed > 0:
                    diff = downloaded - self.last_bytes
                    instant_speed = diff / elapsed

                    # EMA Smoothing (Alpha = 0.1 for smoothness)
                    if not hasattr(self, "avg_speed"):
                        self.avg_speed = instant_speed
                    else:
                        self.avg_speed = 0.1 * instant_speed + 0.9 * self.avg_speed

                    speed = self.avg_speed
                    self.last_bytes = downloaded
                    self.last_time = now
            else:
                # yt-dlp provided speed directly
                self.last_bytes = downloaded
                self.last_time = now

            segments_data = []
            if self.downloader and hasattr(self.downloader, "segments"):
                for s in self.downloader.segments:
                    total_seg = (s["end"] - s["start"]) + 1
                    done_seg = s["downloaded"]
                    p = done_seg / total_seg if total_seg > 0 else 0
                    segments_data.append(p)

            self.progress_signal.emit(downloaded, total, speed, segments_data)

    def emit_status(self, msg):
        if self.is_running:
            self.status_signal.emit(msg)

    def emit_finished(self, success, filename):
        if self.is_running:
            self.finished_signal.emit(success, filename)

    def stop(self):
        self.is_running = False
        if self.downloader:
            self.downloader.stop()
        self.terminate()


class DownloadDialog(QDialog):
    download_complete = Signal(bool, str)
    finished = Signal()

    def __init__(self, url, parent=None, save_dir=None, format_info=None):
        super().__init__(parent)
        self.setWindowTitle(I18n.get("downloading"))
        self.resize(720, 520)
        # Removed frameless flags - now fully resizable with standard controls
        # self.setAttribute(Qt.WA_TranslucentBackground)
        # self.setWindowFlags(self.windowFlags() | Qt.FramelessWindowHint)

        self.url = url
        self.save_dir = save_dir
        self.format_info = format_info
        self.config = ConfigManager()

        proxy_cfg = {
            "enabled": self.config.get("proxy_enabled"),
            "host": self.config.get("proxy_host"),
            "port": int(self.config.get("proxy_port") or 8080),
            "user": self.config.get("proxy_user"),
            "pass": self.config.get("proxy_pass"),
        }

        # FIX: Get max connections from config
        self.max_connections = int(self.config.get("max_connections", 8))

        # FIX: Pass worker_count to worker
        self.worker = DownloadWorker(
            url, save_dir, proxy_config=proxy_cfg, worker_count=self.max_connections, format_info=self.format_info
        )
        # Connect signals
        self.worker.progress_signal.connect(self.update_progress)
        self.worker.status_signal.connect(self.update_status)
        self.worker.finished_signal.connect(self.on_download_finished)
        self.worker.finished.connect(self.worker.deleteLater)

        # Start download
        # CRITICAL: Setup UI - creates all widgets!
        self.setup_ui()

        self.worker.start()

    def setup_ui(self):
        # Simplified for standard window (no longer frameless)
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(25)

        header = QHBoxLayout()
        icon_lbl = QLabel()
        icon = QApplication.style().standardIcon(QStyle.SP_DialogSaveButton)
        icon_lbl.setPixmap(icon.pixmap(54, 54))
        icon_lbl.setStyleSheet(
            "background-color: #1e1e2e; border-radius: 16px; padding: 12px; border: 1px solid #313244;"
        )

        title_box = QVBoxLayout()
        self.fname_lbl = QLabel(I18n.get("initializing"))
        self.fname_lbl.setStyleSheet("font-size: 24px; font-weight: bold; color: white;")

        self.url_lbl = QLabel(self.url)
        self.url_lbl.setStyleSheet("color: #a6adc8; font-size: 13px;")
        font_metrics = self.url_lbl.fontMetrics()
        elided_url = font_metrics.elidedText(self.url, Qt.ElideMiddle, 400)
        self.url_lbl.setText(elided_url)

        title_box.addWidget(self.fname_lbl)
        title_box.addWidget(self.url_lbl)

        header.addWidget(icon_lbl)
        header.addSpacing(15)
        header.addLayout(title_box)
        header.addStretch()
        main_layout.addLayout(header)

        stats_layout = QGridLayout()
        stats_layout.setSpacing(15)

        self.card_speed = MainInfoCard(I18n.get("speed"), "0 MB/s", with_graph=True)
        self.card_eta = InfoCard(I18n.get("eta"), "--:--:--")
        self.card_downloaded = InfoCard(I18n.get("downloaded"), "0 GB")
        self.card_total = InfoCard(I18n.get("total"), I18n.get("unknown"))

        stats_layout.addWidget(self.card_speed, 0, 0)
        stats_layout.addWidget(self.card_eta, 0, 1)
        stats_layout.addWidget(self.card_downloaded, 1, 0)
        stats_layout.addWidget(self.card_total, 1, 1)

        main_layout.addLayout(stats_layout)

        # Dynamic thread count from Config
        max_conn = self.max_connections

        main_layout.addWidget(QLabel(I18n.get("thread_heatmap")))
        self.heatmap = HeatmapBar(segments=max_conn)
        main_layout.addWidget(self.heatmap)

        main_layout.addStretch()

        footer = QHBoxLayout()
        footer.addStretch()

        self.btn_hide = ModernButton(I18n.get("hide"))
        self.btn_hide.clicked.connect(self.hide)

        self.btn_pause = ModernButton(I18n.get("pause"))
        self.btn_pause.clicked.connect(self.toggle_pause)

        self.btn_cancel = ModernButton(I18n.get("cancel"))
        self.btn_cancel.clicked.connect(self.cancel_download)

        footer.addWidget(self.btn_hide)
        footer.addWidget(self.btn_pause)
        footer.addWidget(self.btn_cancel)
        main_layout.addLayout(footer)

    def cancel_download(self):
        if self.worker.is_running:
            self.worker.stop()
        self.reject()

    def update_progress(self, downloaded, total, speed, segments):
        if self.worker.downloader and self.worker.downloader.filename:
            fname = os.path.basename(self.worker.downloader.filename)
            self.fname_lbl.setText(fname)

        # Smooth speed logic is tricky without history, but let's assume 'speed' coming in is instantaneous.
        # We can implement a simple smoother here.
        if not hasattr(self, "_speed_history"):
            self._speed_history = []
        self._speed_history.append(speed)
        if len(self._speed_history) > 5:
            self._speed_history.pop(0)
        avg_speed = sum(self._speed_history) / len(self._speed_history)

        sp_str = f"{avg_speed / (1024 * 1024):.1f} MB/s" if avg_speed > 1024 * 1024 else f"{avg_speed / 1024:.1f} KB/s"
        self.card_speed.set_value(sp_str)
        self.card_speed.update_graph(avg_speed)

        if downloaded > 1024 * 1024 * 1024:
            dl_str = f"{downloaded / (1024 * 1024 * 1024):.2f} GB"
        else:
            dl_str = f"{downloaded / (1024 * 1024):.2f} MB"
        self.card_downloaded.set_value(dl_str)

        if total > 1024 * 1024 * 1024:
            tot_str = f"{total / (1024 * 1024 * 1024):.2f} GB"
        else:
            tot_str = f"{total / (1024 * 1024):.2f} MB"
        self.card_total.set_value(tot_str)

        if total > 0:
            pct = int((downloaded / total) * 100)
            rem = total - downloaded
            if speed > 0:
                secs = int(rem / speed)
                if secs > 86400:  # > 24h
                    eta_str = "> 1d"
                else:
                    try:
                        eta_str = QTime(0, 0, 0).addSecs(secs).toString("HH:mm:ss")
                    except Exception:
                        eta_str = "--:--:--"
            else:
                eta_str = "--:--:--"
            self.card_eta.set_value(eta_str + f"\n({pct}%)")

        if segments:
            self.heatmap.update_segments(segments)

    def update_status(self, msg):
        # Status updates go to window title for now
        pass

    def on_download_finished(self, success, filename):
        """Handle download completion - show dialog and close."""
        from PySide6.QtWidgets import QMessageBox

        from src.core.i18n import I18n
        
        self.download_complete.emit(success, filename)
        self.finished.emit()

        if success:
            # Use CompleteDialog instead
            complete_dlg = CompleteDialog(filename, self)
            complete_dlg.exec()
            QMessageBox.warning(
                self,
                I18n.get("download_failed"),
                I18n.get("download_failed_msg")
            )
        
        # Close the download dialog
        self.accept()

    def toggle_pause(self):
        if self.worker.is_running:
            self.worker.stop()
            self.btn_pause.setText(I18n.get("resume"))
            self.fname_lbl.setText(f"{self.fname_lbl.text()} ({I18n.get('stopped')})")
        else:
            self.worker = DownloadWorker(self.url, self.save_dir, format_info=self.format_info)
            self.worker.progress_signal.connect(self.update_progress)
            self.worker.status_signal.connect(self.update_status)
            self.worker.finished_signal.connect(self.on_finished)
            self.worker.start()
            self.btn_pause.setText(I18n.get("pause"))

    def on_finished(self, success, filename):
        self.download_complete.emit(success, filename)
        if success:
            self.finished.emit()
            if self.config.get("show_complete_dialog", True):
                self.hide()
                # Open Complete Dialog
                comp_dlg = CompleteDialog(filename, self.parent())
                comp_dlg.exec()
            self.accept()
        else:
            # Maybe keep dialog open or show error?
            pass
